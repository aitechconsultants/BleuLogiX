name: Cohesion Check (Boot + Routes + Health)

on:
  pull_request:
  push:
    branches: [ main, develop ]

jobs:
  cohesion:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build

      - name: Boot test + route validation + health check
        env:
          NODE_ENV: test
          PORT: "5055"
          ROUTE_SELF_TEST: "1"
          DATABASE_URL: "postgres://user:pass@localhost:5432/placeholder"
          ENCRYPTION_KEY: "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
          YOUTUBE_OAUTH_CLIENT_ID: "placeholder"
          YOUTUBE_OAUTH_CLIENT_SECRET: "placeholder"
          AFFILIATE_DEFAULT_REDIRECT_URL: "/"
          ADMIN_TOKEN: "placeholder"
        run: |
          node -e "
          const http = require('http');
          const { spawn } = require('child_process');

          const port = process.env.PORT || 5055;
          const proc = spawn('node', ['dist/server/index.js'], {
            stdio: 'inherit',
            env: process.env
          });

          const start = Date.now();
          const timeoutMs = 20000;

          function tryHealth() {
            http.get({ host: '127.0.0.1', port, path: '/health' }, (res) => {
              if (res.statusCode !== 200) {
                console.error('Health check failed');
                proc.kill('SIGTERM');
                process.exit(1);
              }
              console.log('Health check OK');
              proc.kill('SIGTERM');
              process.exit(0);
            }).on('error', () => {
              if (Date.now() - start > timeoutMs) {
                console.error('Server did not become healthy in time');
                proc.kill('SIGTERM');
                process.exit(1);
              }
              setTimeout(tryHealth, 500);
            });
          }

          setTimeout(tryHealth, 500);
          "
